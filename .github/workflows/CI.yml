name: CI ðŸ§

on:
  push:
    branches: [ "develop", "main", "feature/#22-github-action-ci" ]
  pull_request:
    branches: [ "develop" ]

env:
  SECRET_XCCONFIG_PATH: PhotoGether/PhotoGether/Resource/Secrets.xcconfig
  CACHED_SPM_DEPENDENCY_PATH: ~/Library/Developer/Xcode/DerivedData/PhotoGether*/SourcePackages/
  DERIVED_DATA_PATH: ~/Library/Developer/Xcode/DerivedData  

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: âœ… CI
    runs-on: macos-latest

    steps:
      - name: ðŸ·ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ List Xcode installations
        run: sudo ls -1 /Applications | grep "Xcode"

      - name: ðŸ·ï¸ Select XCode 16.0
        run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

      - name: ðŸ·ï¸ Show Xcode version
        run: |
          sudo xcodebuild -version
        
      - name: ðŸ·ï¸ Show swift version
        run: swift --version

      - name: ðŸ·ï¸ Install SwiftLint
        run: brew install swiftlint

      - name: ðŸ·ï¸ Make `Secrets.xcconfig`
        run: |
          touch ${{ env.SECRET_XCCONFIG_PATH }}
          echo "" > ${{ env.SECRET_XCCONFIG_PATH }}

      - name: ðŸ·ï¸ Cache SPM
        uses: actions/cache@v3
        with:
          path: ${{ CACHED_SPM_DEPENDENCY_PATH }}
          key: ${{ runner.os }}-spm-${{ hashFiles('PhotoGether.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: ðŸ·ï¸ Cache DerivedData
        uses: actions/cache@v3
        with:
          path: ${{ DERIVED_DATA_PATH }}
          key: ${{ runner.os }}-iOS_derived_data-xcode_16.0
          restore-keys: |
            ${{ runner.os }}-iOS_derived_data-
      
      
      - name: ðŸ›  Start xcode build iOS 16.0 on iPhone 16 Pro
        env:
          WORKSPACE_PATH: ./PhotoGether/PhotoGether.xcworkspace
        run: >
          xcodebuild 
          -workspace ${{ WORKSPACE_PATH }} 
          -scheme PhotoGether 
          -destination 'platform=iOS Simulator,OS=16.0,name=iPhone 16 Pro'
